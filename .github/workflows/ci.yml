name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install MoonBit (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> "$GITHUB_PATH"

      - name: Install MoonBit (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Set-ExecutionPolicy RemoteSigned -Scope CurrentUser
          irm https://cli.moonbitlang.com/install/powershell.ps1 | iex
          echo "$HOME\\.moon\\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: MoonBit Version
        run: moon version --all

      - name: Test (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          moon test --target native --package core

      - name: Test (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $vswhere = Join-Path ${env:ProgramFiles(x86)} "Microsoft Visual Studio\\Installer\\vswhere.exe"
          $vs = & $vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
          if (-not $vs) { throw "Visual Studio with C++ tools not found." }
          $vcvars = Join-Path $vs "VC\\Auxiliary\\Build\\vcvars64.bat"
          cmd /c "`"$vcvars`" && moon test --target native --package core"
