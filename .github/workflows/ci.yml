name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install MoonBit (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> "$GITHUB_PATH"

      - name: Install MoonBit (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Set-ExecutionPolicy RemoteSigned -Scope CurrentUser
          irm https://cli.moonbitlang.com/install/powershell.ps1 | iex
          echo "$HOME\\.moon\\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: MoonBit Version
        run: moon version --all

      - name: Setup pnpm (latest)
        if: runner.os == 'Linux'
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node (Linux)
        if: runner.os == 'Linux'
        uses: actions/setup-node@v5
        with:
          node-version: 24
          cache: pnpm
          cache-dependency-path: |
            ts/zod-adapter/pnpm-lock.yaml
            ts/yup-adapter/pnpm-lock.yaml
            ts/valibot-adapter/pnpm-lock.yaml

      - name: Install jq (Linux)
        if: runner.os == 'Linux'
        run: |
          JQ_VERSION="1.8.1"
          mkdir -p "$HOME/.local/bin"
          curl -fsSL "https://github.com/jqlang/jq/releases/download/jq-${JQ_VERSION}/jq-linux-amd64" -o "$HOME/.local/bin/jq"
          chmod +x "$HOME/.local/bin/jq"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: jq Version (Linux)
        if: runner.os == 'Linux'
        run: jq --version

      - name: pnpm Version (Linux)
        if: runner.os == 'Linux'
        run: pnpm --version

      - name: Check
        run: moon check -d

      - name: Test (JS)
        run: moon test --target js js

      - name: Test (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          moon test --target native core
          moon test --target native cmd

      - name: Test (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $vswhere = Join-Path ${env:ProgramFiles(x86)} "Microsoft Visual Studio\\Installer\\vswhere.exe"
          $vs = & $vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
          if (-not $vs) { throw "Visual Studio with C++ tools not found." }
          $vcvars = Join-Path $vs "VC\\Auxiliary\\Build\\vcvars64.bat"
          cmd /c "`"$vcvars`" && moon test --target native core && moon test --target native cmd"

      - name: TS Adapter (pnpm lint/typecheck/test)
        if: runner.os == 'Linux'
        working-directory: ts/zod-adapter
        run: |
          pnpm install --frozen-lockfile
          pnpm lint
          pnpm typecheck
          pnpm test

      - name: TS Yup Adapter (pnpm lint/typecheck/test)
        if: runner.os == 'Linux'
        working-directory: ts/yup-adapter
        run: |
          pnpm install --frozen-lockfile
          pnpm lint
          pnpm typecheck
          pnpm test

      - name: TS Valibot Adapter (pnpm lint/typecheck/test)
        if: runner.os == 'Linux'
        working-directory: ts/valibot-adapter
        run: |
          pnpm install --frozen-lockfile
          pnpm lint
          pnpm typecheck
          pnpm test

      - name: Verify Imported Upstream Cases
        if: runner.os == 'Linux'
        run: |
          bash ./scripts/jq_upstream_import.sh
          git diff --exit-code -- scripts/jq_compat_cases.upstream.json scripts/jq_compat_cases.upstream.stage1.json

      - name: Differential Smoke (jq)
        if: runner.os == 'Linux'
        run: bash ./scripts/jq_diff.sh

      - name: Differential Upstream Stage1 (jq)
        if: runner.os == 'Linux'
        run: bash ./scripts/jq_diff.sh scripts/jq_compat_cases.upstream.stage1.json

      - name: Differential Native Exit (jq)
        if: runner.os == 'Linux'
        run: bash ./scripts/jq_diff_native.sh
